// Сколько игроков могут играть одновременно? Как игрок получает опыт? Какие сложности игрок испытывает? Когда становится доступен кооп?

//Идея.

**Описание.**

В игре возможно только онлайн-кооп на одном экране. Каждый игрок должен заходить со своего устройства.

В игре присутствует ко-оп на двух, трех или четырех игроков. Каждый игрок берет на себя одного или двух персонажей. Каждый игрок может играть своими персонажем в любой момент, игрокам не надо соблюдать очередность хода.

**Способ подключения.**

В главном меню игрок выбирает своих друзей из Steam. Игрок, что приглашает своих друзей, выступает в качестве хоста.

**Перемещение по главному хабу.**

Хост выбирает, какой уровень начать. При выборе уровня открывается окно «Ожидание остальных игроков». Для начала уровня все игроки должны находится на экране «Ожидание остальных игроков». Это сделано для того, чтобы игроки могли свободно перемещаться в другие локации, прокачивали своих персонажей.

Начало уровня.

Игроки выбирает перед началом своих персонажей в окне «Выбор персонажа». После того, как все выбрали себе персонажей, хост нажимает «Начать» и запускается уровень.

|                   |                                                                     |
| ----------------- | ------------------------------------------------------------------- |
| В игре два игрока | Хост выбирает себе два персонажа, напарник выбирает себе персонажа. |
| В игре три игрока | Каждый выбирает себе по одному персонажу.                           |


Цель: описать практическую архитектуру, UX и игровые правила для кооперативного режима (2–4 игрока), чтобы он был удобным, честным и органично интегрированным в существующий геймплей (пошаговая тактика без излишнего рандома).

---

**1. Основные параметры коопа**

- Максимум игроков: **2–4** (как в исходном диздоке).
- Правила выбора персонажей: сохраняются договорённости из дока:

- 2 игрока — каждый выбирает по **2 персонажа**;
- 3 игрока — хост выбирает **2**, остальные по **1**;
- 4 игрока — каждый по **1**.

- Режим: **онлайн-кооператив на отдельном сервере/у хоста** (возможен и локальный хост для “партии друзей”).
- Синхронизация: **авторитетный хост** (host-authoritative). Поскольку игра пошаговая и предсказуемая, это простая, надёжная и отлаженная архитектура: клиенты отправляют решения/действия, хост проверяет, применяет и рассылает финальное состояние для визуализации у всех.

---

**2. Сетевой / технический дизайн**

**2.1 Архитектура**

- **Host authoritative (peer-host)**: один игрок выступает хостом (по умолчанию — создатель лобби).

- Хост сохраняет и верифицирует игровое состояние (поля, позиции, действия), вычисляет результаты и рассылает обновления.
- Клиенты отправляют команды (выбрать способность, переместить, применить предмет) и получают от хоста подтверждение результата.

- **Резервное решение (dedicated server)** — опция для релиза или матчмейкинга; в ранних прототипах можно использовать P2P с хостом.
- **Пакеты/повторы:** сообщения небольшие и редкие (ходы, действия, активации предметов), поэтому UDP с подтверждением/повтором для критичных пакетов или над TCP для простоты.

**2.2 Синхронизация ходов**

- Пошаговая игра → **раунд = «ход команды»**. В коопе все игроки действуют в рамках одного «хода команды» (нет строгой «по очереди» привязки к игрокам).
- Модель: **фаза планирования + фаза подтверждения**:

1. Все игроки/клиенты по очереди ставят свои команды/приказы (перемещения, способности, использование расходников) на единую панель хода.
2. Когда все подтвердили или истёк таймер, хост выполняет все команды в детерминированном порядке (по приоритетам: мгновенные эффекты → перемещение → атаки → AOE → окружение), проверяет конфликтные ситуации и рассылает результат.

- Таймер на подтверждение действий (опционально для публичных матчей) — чтобы партия не «висела» бесконечно. В приватных играх хост может снять таймер.

**2.3 Клиентская предикция / визуализация**

- Для плавности UI: клиенты показывают локальную превизуализацию своих действий (с пометкой “ожидает подтверждение”), но окончательный результат подтверждает хост. Это минимизирует ощущение лагов и не ломает честность.

**2.4 Обработка потерь соединения**

- **Drop-out**: если игрок отключился, его персонажи берёт под контроль ИИ (с заранее заданной агрессивностью/поведенческими правилами) или дают опцию заменить отключившегося игрока ботом. Хост отображает сообщение и может дать время на переподключение.
- **Rejoin**: при переподключении клиент получает текущее состояние от хоста и продолжает.
- **Host migration**: в случае падения хоста — если реализовано, один из клиентов (по приоритету ping/uptime) становится новым хостом; в противном случае сессия завершается и клиентам предлагается сохранить локальную копию прогресса.

---

**3. Игровая логика и баланс в коопе**

**3.1 Балансирование сложности**

- **Скалирование врагов**:

- Увеличение HP/щитов и/или количества врагов пропорционально числу игроков.
- Альтернативно — увеличение сложности за счёт новых паттернов, а не чистого HP-баффа.

- **Ресурсы и расходники**:

- **Персонажные предметы и амулеты** — покупаются и устанавливаются индивидуально в хабе; не делятся (каждый получает доступ к своей коллекции и слоту амулетов).
- **Деньги / награды за бой** — каждый игрок получает свои награды (чтобы не было «зависимости» от хоста). Награда масштабируется по вкладу/сложности: все получают базовый доход, но дополнительные бонусы за вклад (ассисты, выполненные задания) идут персонально.
- **Метапредметы**: применяются до боя — если в ходу несколько игроков выбрали метапредметы, их эффекты стекаются по правилам (приоритеты/ограничения). Можно ввести правило «макс. 2 метапредмета на сессию» для контроля баланса.

**3.2 Правила выбора персонажей**

- Как в доке: хост/игроки выбирают персонажей в соответствии с правилами 2/3/4-игроков (система предотвращает дублирование униковых персонажей, если это важно).
- **Синергии**: интерфейс подсказывает синергии между персонажами (подсветка, рекомендации), т.к. в коопе кооперация важна.

**3.3 Совместное использование интерфейсов поля боя**

- **Маркировка целей**: игрок может ставить «пинг» на тайл/врага — виден всем (краткая подсказка).
- **Quick-commands**: быстрые команды (например, «уменьшить приоритет», «фокус на этой цели», «отступаем») — для координации без голоса.
- **Совместное использование предметов**: расходники применяются игроком только на свои юниты (но можно применять на любого союзника/врага по таргетингу), поэтому нет необходимости «делить» слот.

---

**4. UX/интерфейс кооператива**

**4.1 Лобби и матчмейкинг**

- **Создание лобби**:

- хост создаёт приватное/публичное лобби; приглашает друзей (Steam/PLATFORM invites) или используется матчмейкинг.
- отобразить правила выбора персонажей для текущего размера партии.

- **Панель игроков** в лобби: аватар, выбранные персонажи, подключение, ping, готовность.
- **Кнопки**: invite, kick (host only), ready, start (host).
- **Пресеты билдов**: видно у каждого игрока (опционально — можно просмотреть чужие билд-пресеты).

**4.2 В бою — HUD**

- Вверху/сбоку — панель игроков: их персонажи, HP/щит/энергия, состояние (stan/stun), ping.
- **Shared turn panel**: список команд всех игроков (показывает, кто ещё не подтвердил ход).
- **Chat / pings / quick commands**: чат и пиктограммы в HUD.
- **Vote UI**: для голосования (retry, skip level, surrender, kick).

**4.3 Поддержка координации**

- **Подсказки баланса**: если в партии не хватает ролей (нет хилера, нет танка), система мягко подсказывает (не запрещая выбор): «В партии нет хилера — игра будет сложнее».
- **Предпросмотр итогов боя**: после завершения боя каждый игрок видит собственный разбор (что он получил) + общий разбор (платформа для обучения).

---

**5. Прогрессия и сохранение**

- **Персональная прогрессия**: амулеты, рунные очки, деньги и разблокировки — сохраняются персонально. Каждый игрок получает полные награды по окончании боя (в разумных пределах). Это предотвращает «воровство» прогресса у хоста.
- **Коллективные трофеи/ачивки**: за совместное выполнение особых заданий выдаются единые ачивки, но материалы/деньги — личные.
- **Сохранение хоста**: если хост — локальный, рекомендуется сохранять сессии автоматически и давать игрокам возможность экспортировать результаты (например, локальная копия). При dedicated сервере — прогресс всё равно в аккаунте каждого игрока.

---

**6. Политики по фарму и честности**

- **Анти-эксплойты**: ограничение повторного фарма одних и тех же боёв за быстрый доход (например, снижающийся коэффициент денег при частом перепрохождении того же уровня в короткий промежуток времени).
- **Валидация на хосте**: хост проверяет невозможные состояния (нелегальное увеличение ресурсов/HP) и откатывает/логирует нарушения.
- **Собственная экономика** (персональные награды) снижает мотивацию к мошенничеству через «передачу богатств».

---

**7. Social / коммуникация**

- **Голосовой чат + текст** внутри лобби и во время игры (опционально mute).
- **Ping система**: несколько типов пингов — «враг», «позиция», «пожать», «используй предмет» (для игроков без голосовой связи).
- **Система друзей / быстрые приглашения**: интеграция с платформой (Steam/консоли) для быстрого приглашения.

---

**8. Поведенческие и UX-детали**

- **Быстрый вход/выход**: игроки могут заходить и выходить между уровнями; во время боя — только с предупреждением (и с заменой ботом).
- **Баланс нагрузки**: если игрокы слишком «перегибают» (все берут агрессивные билды), подсказки/строгость не вводятся — игроки свободны в экспериментах; но хардкорный челлендж будет отражён в награде.
- **Лёгкий режим для коопа**: опция «friends assist» — снижает HP врагов/дает дополнител. щиты, чтобы поддержать менее опытных друзей (настраивается хостом перед стартом).

---

**9. Примеры игровых сценариев (практический взгляд)**

1. **Друзья создают приватный матч (3 игрока)** — хост выбирает 2 персонажа, остальные по одному. На стадии подготовки каждый покупает свои расходники. В бою игроки одновременно планируют действия, подтверждают ход — хост выполняет их и рассылает результат. Награды получают каждый персонально.
2. **Публичный матч (4 игрока)** — таймер планирования 60s; если кто-то не подтвердил — его персонажи пропускают действия (или действуют по предустановленному поведению).
3. **Игрок отключился во время боя** — через 30s его персонажей берёт ИИ, остальные играют дальше; если игрок перезаходит — он возвращается к управлению сохранёнными персонажами.

---

**10. Тестирование и MVP-план**

1. **Фаза прототипа (локальный/peer host)**: реализовать базовую сеть хост-authority + UI для лобби и совместного выбора персонажей. Тест: 2–4 игрока, подтверждение хода, рассылка состояния.
2. **Плейтесты**: внутренняя команда тестирует таймеры, сценарии drop-out, баланс сложности.
3. **MVP**: добавить matchmaking (опционально), приглашения друзьям, базовую голосовую/текстовую связь, бот-замены.
4. **Публичные беты**: измерять метрики: время ожидания, средний ping, частота reconnect, распределение ролей, жалобы на баланс.

---

**11. Дополнительные рекомендации**

- Сделать кооператив **доступным, но необязательным**: игроки не должны чувствовать, что кооп — единственный путь к контенту.
- Разработать “кооп-трофеи” и небольшую систему достижений, которые стимулируют совместную игру, но не разрушают одиночную прогрессию.
- Инвестировать в понятные визуальные средства координации (ping, quick commands) — это повышает удовлетворение командной игры заметно сильнее, чем голосовой чат.

---

**Итог**

Реализация коопа строится вокруг простых и надёжных принципов: авторитетный хост, персональная прогрессия, масштабирование сложности и удобный UX для координации. Такой подход минимизирует сетевые ошибки, сохраняет честность экономики и максимально раскрывает кооперативный потенциал игры — совместное планирование, синергии билдов и радость от слаженных тактических комбинаций.